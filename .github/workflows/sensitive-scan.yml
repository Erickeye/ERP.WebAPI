name: Sensitive Word Check

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main"]

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Scan for sensitive keywords
        run: |
          echo "Scanning for sensitive words..."
          
          # 敏感字
           SENSITIVE_WORDS=(
            "password"
            "secret" "apikey" "api_key"
            "client_secret" "client_id" "appsecret" "application_secret"
            "jwt" "bearer" "auth" "authentication" "credential"
            "username" "user_name" "account" "useraccount" "login"
            "creditcard" "cardnumber" "card_no" "cvv" "cvc"
            "bank_account" "bankaccount" "iban" "swift"
            "idnumber" "id_number" "national_id" "identity"
            "fullname" "full_name" "first_name" "last_name"
            "phone" "mobile" "email" "address" "birthday" "birthdate"
            "personalinformation" "personal_info"
            "connectionstring" "connection_string" "datasource"
            "db_user" "db_password" "ftpuser" "ftppassword"
            "smtp_password" "smtp_user"
            "privatekey" "private_key" "publickey" "public_key"
            "sshkey" "ssh_key"
            "admin" "superadmin" "root" "sa" "masterkey" "master_key"
          )

          # 專案程式碼路徑
          TARGET_DIR="src"

          FOUND=0

          # 排除 bin/obj/.git 之類無意義的資料夾
          EXCLUDES="--exclude-dir=bin --exclude-dir=obj --exclude-dir=.git"

          for word in "${SENSITIVE_WORDS[@]}"; do
            echo "Searching: $word"

            if grep -Rni $EXCLUDES "$word" "$TARGET_DIR"; then
              echo "::error file=$TARGET_DIR::❌ Sensitive word found: $word"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "❌ Sensitive words detected. Blocking."
            exit 1
          else
            echo "✔ No sensitive words found."
          fi
